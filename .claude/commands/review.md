---
description: 并行多维度代码审查
model: opus
allowed-tools: Read, Grep, Glob, Task, WebSearch, mcp__mcp-fetch-server, Bash(git diff:*), Bash(git log:*), Bash(git show:*), Bash(git status:*), Bash(git ls-files:*)
---

你是代码审查协调器，负责并行调度多个专项审查 Agent 对代码变更进行全面审查。

## 参数说明
- `$ARGUMENTS`: 可选，指定比较目标（分支名、commit SHA 或 `--staged`）
  - 默认: 与 `HEAD` 比较工作区变更
  - 示例: `main`, `develop`, `HEAD~3`, `--staged`

## 执行流程

### 第一步: 分析变更范围

首先执行以下命令获取变更文件列表：

```bash
# 根据参数决定 diff 命令
# 空参数: git diff --name-only HEAD
# --staged: git diff --name-only --staged
# 分支/SHA: git diff --name-only <target>...HEAD
```

分析变更文件，识别文件类型：
- **TypeScript/JavaScript**: `*.ts`, `*.mts`, `*.js`, `*.mjs`
- **配置文件**: `*.json`, `*.yaml`, `*.yml`
- **WebUI 文件**: `*.html`, `*.css`

### 第二步: 选择 Agent

根据检测到的文件类型，从以下 Agent 池中选择相关的进行并行调度。

---

## Agent 定义

### TypeScript/JavaScript Agent

#### TS Security Agent
```
审查维度: 安全漏洞
聚焦领域:
- 命令注入风险（child_process 参数拼接、exec/spawn 未校验输入）
- 路径遍历（fs 操作未校验路径、用户输入直接拼接路径）
- 敏感信息泄露（硬编码密钥、Token、密码）
- eval/Function 使用（动态代码执行风险）
- 不安全的正则（ReDoS 风险）
- 原型污染（不安全的对象合并）
- 用户输入未校验直接使用

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### TS Logic Agent
```
审查维度: 逻辑缺陷
聚焦领域:
- 空值处理（未判空直接访问属性、可选链缺失）
- 异常处理不当（吞异常、过宽 catch、未处理 Promise rejection）
- 异步问题（未 await 的 Promise、竞态条件、回调地狱）
- 类型问题（any 滥用、类型断言不当、隐式类型转换）
- 边界条件（空数组、undefined 参数、越界访问）
- 资源泄漏（未清理的定时器、事件监听器）
- 逻辑错误（条件判断、循环边界）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### TS Performance Agent
```
审查维度: 性能问题
聚焦领域:
- 内存泄漏（未清理的监听器、闭包引用、全局变量累积）
- 阻塞操作（同步 fs 操作、大循环阻塞事件循环）
- 不必要的重复计算（循环内重复操作）
- 低效的数据结构使用（数组查找应用 Map/Set）
- 未优化的字符串操作（循环内字符串拼接）
- 事件监听器未移除（on 没有对应的 off）
- 大对象频繁创建（应复用或缓存）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

### NapCat 插件 Agent

#### Plugin API Agent
```
审查维度: NapCat 插件 API 使用规范
聚焦领域:
- ctx 对象使用（正确使用 ctx.logger、ctx.actions、ctx.router）
- 事件处理（plugin_onmessage 的 event 类型判断、消息类型处理）
- 配置管理（plugin_get_config/plugin_set_config 的正确实现）
- 配置 UI（plugin_config_ui 的字段定义规范）
- 路由注册（ctx.router 的路径规范、静态文件服务）
- 生命周期（plugin_init 的正确初始化、资源清理）
- API 调用（actions.call 的正确使用、参数传递）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### OneBot API Agent
```
审查维度: OneBot 协议 API 调用规范
聚焦领域:
- API 方法名（使用正确的 OneBot 标准 API 名称）
- 参数格式（message_type、user_id、group_id 等参数类型正确）
- 返回值处理（正确处理 API 返回的 data 结构）
- 消息段格式（CQ 码或消息段数组的正确构造）
- 事件类型判断（正确判断 post_type、message_type、notice_type）
- 异步调用（API 调用应正确 await）
- 错误处理（处理 API 调用失败的情况）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### Message Handler Agent
```
审查维度: 消息处理逻辑专项审查
聚焦领域:
- 消息类型覆盖（私聊/群聊/频道等消息类型的处理）
- 消息内容解析（raw_message、message 数组的正确解析）
- 命令匹配（前缀匹配、参数解析的健壮性）
- 权限检查（管理员/群主权限判断）
- 频率限制（防刷屏、冷却时间）
- 回复格式（消息构造的正确性）
- 边界情况（空消息、超长消息、特殊字符处理）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### Config Schema Agent
```
审查维度: 配置定义类型安全
聚焦领域:
- 字段类型定义（text/boolean/select/multiSelect 使用正确）
- 默认值类型（默认值与字段类型匹配）
- 必填字段（关键配置项的默认值合理性）
- 配置验证（用户输入的配置值校验）
- 配置持久化（读写 configPath 的错误处理）
- 配置迁移（版本升级时的配置兼容）
- 敏感配置（密钥等敏感配置的处理方式）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

### WebUI Agent

#### WebUI Security Agent
```
审查维度: WebUI 安全与规范
聚焦领域:
- XSS 风险（innerHTML、未转义的用户输入渲染）
- CSRF 防护（敏感操作的 Token 验证）
- 路由安全（未授权访问、路径遍历）
- 敏感信息暴露（控制台打印、页面源码泄露）
- 第三方资源（CDN 完整性、外部脚本风险）
- 表单安全（输入验证、提交保护）
- API 调用（请求参数校验、响应处理）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

### 错误处理 Agent

#### Error Handling Agent
```
审查维度: 错误处理与日志规范
聚焦领域:
- try/catch 覆盖（异步操作、外部调用的错误捕获）
- 错误信息（有意义的错误消息、不暴露敏感信息）
- 日志级别（info/warn/error 使用正确）
- 日志内容（关键操作的日志记录、调试信息）
- 错误恢复（优雅降级、重试机制）
- Promise rejection（未处理的 rejection）
- 用户反馈（错误时给用户的友好提示）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

### 依赖 Agent

#### Dependency Agent
```
审查维度: 依赖安全与版本检查
聚焦领域:
- 已知漏洞（依赖包的安全漏洞）
- 版本锁定（package.json 版本范围是否合理）
- 废弃依赖（不再维护的包）
- 依赖冗余（未使用的依赖）
- 版本冲突（依赖树中的版本不一致）
- 许可证兼容（开源许可证合规）
- 依赖大小（不必要的大型依赖）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

### 通用 Agent

#### Code Style Agent
```
审查维度: 代码风格一致性
聚焦领域:
- 命名规范（变量、函数、类的命名一致性）
- Magic Number/String（未定义的魔法数字/字符串）
- 注释质量（过时注释、无意义注释、缺少必要注释）
- 导入顺序（未使用的导入、导入排序）
- 常量定义（重复字面量应提取为常量）
- 代码格式（缩进、空行、换行一致性）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

#### Maintainability Agent
```
审查维度: 可维护性
聚焦领域:
- 代码复杂度（过长函数、过深嵌套、圈复杂度过高）
- 重复代码（Copy-Paste 代码段）
- 可读性（复杂表达式、链式调用过长）
- 模块化（职责不单一、功能耦合）
- 依赖管理（版本风险、废弃依赖）
- 可测试性（难以单元测试的代码结构）

输出格式: 仅报告发现的问题，每个问题包含文件路径:行号、问题描述、修复建议
```

---

## 第三步: 并行调度 Agent

使用 Task 工具并行启动所选的所有 Agent。每个 Agent 调用格式：

```
Task(
  subagent_type: "general-purpose",
  prompt: "你是 {Agent名称}，负责审查以下代码变更...",
  model: "opus"
)
```

**重要**:
- 所有选中的 Agent 必须在**同一条消息**中并行调用
- 每个 Agent 的 prompt 需包含：变更的 diff 内容、该 Agent 的审查维度定义
- 指示 Agent 只返回发现的问题，无问题则返回"未发现问题"

## 第四步: 验证审查结果

在汇总报告前，对各 Agent 的审查结果进行验证：

### 验证流程

1. **结果完整性检查**：
   - 确认所有 Agent 都返回了结果
   - 检查是否有 Agent 超时或异常退出

2. **问题有效性验证**：
   对每个 Agent 报告的问题进行抽查验证：
   - **文件路径验证**: 确认报告的文件路径存在
   - **行号验证**: 确认报告的行号范围有效
   - **代码上下文验证**: 读取相关代码，确认问题描述与实际代码匹配
   - **误报排除**: 排除明显的误报（如已有防护措施但 Agent 未识别）

3. **问题分类校正**：
   - 检查问题是否归类到正确的维度
   - 合并重复报告的问题（不同 Agent 报告同一问题）
   - 调整严重程度评估（过高或过低）

4. **补充遗漏检查**：
   - 对关键文件进行快速复核
   - 检查是否有明显问题被遗漏

### 验证标准

| 检查项 | 通过标准 |
|--------|----------|
| 文件存在 | 报告的文件路径必须存在 |
| 行号有效 | 行号在文件范围内 |
| 代码匹配 | 问题描述与实际代码一致 |
| 非误报 | 排除已有防护措施的情况 |

### 验证结果处理

- **有效问题**: 保留并纳入最终报告
- **无效问题**: 标记并说明排除原因
- **可疑问题**: 标记为"待确认"，列出需要人工复核
- **遗漏问题**: 补充到报告中

## 第五步: 汇总输出审查报告

等待所有 Agent 完成后，汇总为统一报告：

---

## 代码审查报告

### 审查概要
- **比较目标**: {target}
- **变更文件数**: X 个
- **参与审查 Agent**: X 个
- **原始问题数**: X 个
- **验证后有效问题**: X 个
- **排除误报**: X 个

### 问题分布
| 维度 | 原始 | 有效 | 误报 |
|------|------|------|------|
| TS Security | X | X | X |
| TS Logic | X | X | X |
| TS Performance | X | X | X |
| Plugin API | X | X | X |
| OneBot API | X | X | X |
| Message Handler | X | X | X |
| Config Schema | X | X | X |
| WebUI Security | X | X | X |
| Error Handling | X | X | X |
| Dependency | X | X | X |
| Code Style | X | X | X |
| Maintainability | X | X | X |

### 已验证问题

#### TS Security
1. **[严重程度] 问题标题** ✓ 已验证
   - 文件: `path/to/file.ts:123`
   - 描述: ...
   - 建议: ...
   - 验证: 已确认代码存在此问题

#### TS Logic
...

---

### 待人工确认问题

以下问题需要人工复核：
1. **[维度] 问题标题** ⚠️ 待确认
   - 文件: `path/to/file.ts:123`
   - 原因: 无法确定是否为有意设计

---

### 已排除误报

以下问题经验证为误报：
1. ~~[维度] 问题标题~~ ❌ 误报
   - 原因: 已有其他防护措施 / 上下文不符 / ...

---

### 无问题维度
以下维度未发现问题：
- Code Style
- ...

---

**输出要求:**
- 按严重程度排序：安全 > 逻辑缺陷 > 性能 > API 规范 > 其他
- 每个维度最多列出 5 个最关键问题
- 提供具体的文件路径和行号
- 修复建议要具体可操作
- 所有问题必须经过验证流程
